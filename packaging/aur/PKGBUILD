# Maintainer: <your name> <your@email>
# Contributor: 0x00002a <markus@optiikka.io>

pkgname=libfprint-goodixtls511-git
pkgver=r1818.834f5f9
pkgrel=1
pkgdesc="libfprint with Goodix GF511 (27c6:5110) TLS fingerprint sensor driver"
arch=('x86_64')
url="https://github.com/buxel/libfprint.git"
license=('LGPL-2.1-or-later')

# Replaces the official libfprint so fprintd and pam_fprintd keep working
provides=('libfprint' 'libfprint-2.so=2-64')
conflicts=('libfprint' 'libfprint-goodixtls-git')
# replaces=('libfprint-goodixtls-git')  # intentionally omitted: goodixtls-git covers
                                         # multiple Goodix TLS sensors; only replace it
                                         # if the user explicitly chooses this package

depends=('libgusb' 'gnutls' 'libgudev')
makedepends=('git' 'meson' 'pkgconf' 'glib2-devel')
optdepends=('fprintd: D-Bus daemon for fingerprint authentication')

# When building locally, install.sh sets LIBFPRINT_LOCAL_REPO to the on-disk
# repo so no push to a remote is required.  When published on the AUR, set
# url= above and remove the override so the normal git+https source is used.
_repo="${LIBFPRINT_LOCAL_REPO:-}"
if [[ -n "$_repo" ]]; then
    source=("${pkgname}::git+file://${_repo}")
else
    source=("${pkgname}::git+${url}#branch=goodixtls-on-1.94.9")
fi
sha256sums=('SKIP')

pkgver() {
    cd "${srcdir}/${pkgname}"
    printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

build() {
    cd "${srcdir}/${pkgname}"
    meson setup build \
        --buildtype=release \
        --prefix=/usr \
        -Ddoc=false \
        -Dgtk-examples=false \
        -Dintrospection=false \
        -Dgoodixtls=enabled \
        -Dc_args="-Wno-error=incompatible-pointer-types"
    ninja -C build
}

check() {
    cd "${srcdir}/${pkgname}"
    ninja -C build test
}

package() {
    cd "${srcdir}/${pkgname}"
    DESTDIR="${pkgdir}" ninja -C build install

    # Install udev rules so the sensor is accessible without root
    # (ninja install already handles this via meson's udev_rules_dir detection)
}
